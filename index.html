<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    
    <title>FIRECalc</title>
    <script>
        const urlParams = new URLSearchParams(window.location.search);
        const isForcedMobile = urlParams.get('force') === 'true';
        const isForcedDesktop = urlParams.get('desktop') === 'true' || window.location.search.includes('desktop');

        if ((window.innerWidth < 768 || isForcedMobile) && !isForcedDesktop) {
            window.location.href = 'mobile.html' + window.location.search;
        }
    </script>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ðŸ“ˆ</text></svg>">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;900&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="index.css">
    <script type="importmap">
{
  "imports": {
    "react-dom/": "https://esm.sh/react-dom@^19.2.3/",
    "@google/genai": "https://esm.sh/@google/genai@^1.34.0",
    "react/": "https://esm.sh/react@^19.2.3/",
    "react": "https://esm.sh/react@^19.2.3",
    "vite": "https://esm.sh/vite@^7.3.1",
    "@vitejs/plugin-react": "https://esm.sh/@vitejs/plugin-react@^5.1.2",
    "path": "https://esm.sh/path@^0.12.7"
  }
}
</script>
</head>
<body class="text-slate-300 bg-[#0B0F19] font-inter">

    <!-- Loading State -->
    <div id="login-screen" class="fixed inset-0 flex items-center justify-center bg-[#0B0F19] z-50">
        <div class="p-8 text-center w-full">
            <h1 class="text-4xl font-black mb-2 text-white tracking-tighter">FIRECalc</h1>
            <div class="flex items-center justify-center gap-3 text-blue-500 font-bold uppercase tracking-widest text-xs mt-8">
                <i class="fas fa-circle-notch fa-spin text-lg"></i>
                Authenticating...
            </div>
        </div>
    </div>

    <!-- Guest Warning Modal -->
    <div id="guest-modal" class="fixed inset-0 flex items-center justify-center bg-black/80 z-[60] hidden backdrop-blur-sm">
        <div class="glass-panel p-8 rounded-[24px] shadow-2xl max-w-md text-center mx-4 relative">
            <div class="w-16 h-16 bg-white/5 rounded-2xl flex items-center justify-center mx-auto mb-6 border border-white/10">
                <i class="fas fa-hdd text-3xl text-blue-400"></i>
            </div>
            <h2 class="text-2xl font-black text-white mb-2 tracking-tight">Guest Mode</h2>
            <p class="text-slate-400 text-sm leading-relaxed mb-8">
                Data is stored <strong class="text-white">locally on this device</strong>. <br>
                Clear your cache and it's gone.
            </p>
            <button id="ack-guest-btn" class="w-full py-3 bg-blue-600 hover:bg-blue-500 text-white rounded-xl font-bold transition-all shadow-lg shadow-blue-900/20 uppercase tracking-widest text-xs">
                I Understand
            </button>
        </div>
    </div>

    <!-- Profile Selection Modal -->
    <div id="profile-modal" class="fixed inset-0 flex items-center justify-center bg-black/90 z-[70] hidden backdrop-blur-md px-6">
        <div class="w-full max-w-4xl">
            <div class="text-center mb-12">
                <h2 class="text-4xl font-black text-white mb-2 tracking-tighter uppercase">Choose Your Path</h2>
                <p class="text-slate-500 font-bold uppercase tracking-widest text-xs">Select a baseline profile to begin your simulation</p>
            </div>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                <!-- Starter Card -->
                <button data-profile="25" class="glass-panel p-8 rounded-[32px] border border-white/10 hover:border-teal-500/50 hover:bg-teal-500/5 transition-all group flex flex-col items-center text-center">
                    <div class="w-24 h-24 rounded-full bg-teal-500/10 flex items-center justify-center mb-6 border border-teal-500/20 group-hover:scale-110 transition-transform">
                        <i class="fas fa-seedling text-4xl text-teal-400"></i>
                    </div>
                    <h3 class="text-xl font-black text-white mb-1">The Starter</h3>
                    <p class="text-[10px] text-teal-500 font-black uppercase tracking-widest mb-4">25 â€¢ Single â€¢ Renter</p>
                    <p class="text-xs text-slate-400 leading-relaxed">Early career focusing on aggressive compounding and debt management.</p>
                </button>

                <!-- Accumulator Card -->
                <button data-profile="45" class="glass-panel p-8 rounded-[32px] border border-blue-500/30 bg-blue-500/5 hover:border-blue-500 hover:bg-blue-500/10 transition-all group flex flex-col items-center text-center">
                    <div class="w-24 h-24 rounded-full bg-blue-500/20 flex items-center justify-center mb-6 border border-blue-500/40 group-hover:scale-110 transition-transform shadow-lg shadow-blue-500/20">
                        <i class="fas fa-users text-4xl text-blue-400"></i>
                    </div>
                    <h3 class="text-xl font-black text-white mb-1">Accumulator</h3>
                    <p class="text-[10px] text-blue-500 font-black uppercase tracking-widest mb-4">45 â€¢ Family â€¢ Mortgage</p>
                    <p class="text-xs text-slate-400 leading-relaxed">Mid-career complexity with dependents, multiple income streams, and benefits.</p>
                </button>

                <!-- Retiree Card -->
                <button data-profile="55" class="glass-panel p-8 rounded-[32px] border border-white/10 hover:border-purple-500/50 hover:bg-purple-500/5 transition-all group flex flex-col items-center text-center">
                    <div class="w-24 h-24 rounded-full bg-purple-500/10 flex items-center justify-center mb-6 border border-purple-500/20 group-hover:scale-110 transition-transform">
                        <i class="fas fa-umbrella-beach text-4xl text-purple-400"></i>
                    </div>
                    <h3 class="text-xl font-black text-white mb-1">Pre-Retiree</h3>
                    <p class="text-[10px] text-purple-500 font-black uppercase tracking-widest mb-4">55 â€¢ Married â€¢ Paid Off</p>
                    <p class="text-xs text-slate-400 leading-relaxed">Final approach to retirement. Focus on withdrawal strategies and tax-free income.</p>
                </button>
            </div>
        </div>
    </div>

    <div id="app-container" class="hidden flex h-screen overflow-hidden relative">
        <!-- Sidebar: Glass Effect -->
        <aside class="sidebar w-64 flex flex-col flex-shrink-0 bg-[#0B0F19]/80 backdrop-blur-xl border-r border-white/5 z-20">
            <div class="p-6 pb-2">
                <div class="flex items-center justify-between mb-1">
                    <h1 class="text-xl font-black text-white tracking-tight">FIRECalc</h1>
                    <!-- Buy Me a Coffee -->
                    <div class="flex items-center gap-1.5">
                        <span class="text-[9px] font-black text-amber-500 uppercase tracking-widest">Donate:</span>
                        <a href="https://buymeacoffee.com/timdegraff" target="_blank" class="text-amber-500 hover:text-amber-400 transition-colors text-xs" title="Buy me a coffee">
                            <i class="fas fa-coffee"></i>
                        </a>
                    </div>
                </div>
                <p class="label-std text-slate-500">Retirement Engine</p>
            </div>
            
            <nav class="flex-grow px-3 py-2 space-y-1 overflow-y-auto" id="main-nav">
                <button data-tab="assets-debts" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-wallet w-5 text-center text-orange-400"></i><span>Assets</span></button>
                <button data-tab="income" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-money-bill-wave w-5 text-center text-teal-400"></i><span>Income</span></button>
                <button data-tab="budget" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-chart-pie w-5 text-center text-pink-500"></i><span>Budget</span></button>
                <button data-tab="assumptions" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-sliders-h w-5 text-center text-emerald-400"></i><span>Configuration</span></button>
                <button data-tab="benefits" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-hand-holding-heart w-5 text-center text-amber-400"></i><span>Benefits</span></button>
                <button data-tab="projection" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-chart-line w-5 text-center text-blue-400"></i><span>Projection</span></button>
                <button data-tab="burndown" class="tab-btn w-full text-left p-3 flex items-center gap-3"><i class="fas fa-stairs w-5 text-center text-purple-400" style="transform: scaleX(-1);"></i><span>Burndown</span></button>
            </nav>
            
            <div class="p-4 border-t border-white/5 bg-black/10">
                <div class="mb-4">
                    <p class="label-std text-slate-500 mb-1">Net Worth</p>
                    <p id="sidebar-networth" class="text-lg font-black text-teal-400 tracking-tight mono-numbers">$0</p>
                    <div id="sidebar-asset-legend" class="grid grid-cols-2 gap-x-4 gap-y-1 w-full mt-3"></div>
                </div>
                <div class="flex items-center gap-3 mb-3">
                    <img id="user-avatar" class="w-8 h-8 rounded-full border border-white/10" src="" alt="">
                    <p id="user-name" class="font-bold text-slate-300 text-[11px] truncate"></p>
                </div>
                <div class="flex gap-2">
                    <!-- Save Indicator -->
                    <div id="save-indicator" class="flex-1 py-1.5 bg-white/5 rounded-lg text-center flex items-center justify-center gap-1 border border-white/5 text-slate-600 transition-colors duration-200" title="Data Sync Status">
                        <i class="fas fa-cloud text-xs"></i>
                    </div>
                    <button id="logout-btn" class="flex-[3] py-1.5 bg-white/5 hover:bg-red-500/20 text-slate-400 hover:text-red-400 rounded-lg text-[10px] font-bold uppercase tracking-wider transition-colors border border-white/5">Logout</button>
                </div>
            </div>
        </aside>

        <main class="main-content flex-grow p-6 md:p-8 overflow-y-auto bg-[#0B0F19]">
            <!-- Assets & Debts Tab -->
            <section id="tab-assets-debts" class="tab-content max-w-7xl mx-auto">
                <!-- Summary Widgets -->
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p class="label-std mb-2 text-slate-500">Total Assets</p>
                        <p id="sum-assets" class="text-4xl font-black text-teal-400 mono-numbers tracking-tight">$0</p>
                    </div>
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p class="label-std mb-2 text-slate-500">Total Liabilities</p>
                        <p id="sum-liabilities" class="text-4xl font-black text-red-400 mono-numbers tracking-tight">$0</p>
                    </div>
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28 relative overflow-hidden group">
                        <div class="absolute inset-0 bg-teal-500/5 group-hover:bg-teal-500/10 transition-colors"></div>
                        <p class="label-std mb-2 text-teal-500">Net Worth</p>
                        <p id="sum-networth" class="text-4xl font-black text-teal-400 mono-numbers tracking-tight relative z-10">$0</p>
                    </div>
                </div>

                <!-- Investments Table -->
                <div class="mb-12">
                    <div class="flex justify-between items-end mb-6 px-1">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center text-orange-500 shadow-lg shadow-orange-500/10">
                                <i class="fas fa-chart-line text-sm"></i>
                            </div>
                            <div>
                                <h2 class="text-xl font-bold text-white tracking-tight">Investments</h2>
                                <p class="text-xs text-slate-500 font-medium mt-0.5">Liquid assets and retirement accounts</p>
                            </div>
                        </div>
                        <button data-add-row="investment-rows" data-row-type="investment" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-900/20"><i class="fas fa-plus mr-2"></i>Add Account</button>
                    </div>
                    <div class="card-container overflow-hidden">
                        <table class="w-full text-xs">
                            <thead class="text-slate-500 label-std border-b border-white/5">
                                <tr><th class="w-6"></th><th class="text-left w-[35%]">Account Name</th><th class="text-left w-[20%]">Asset Class</th><th class="text-right group cursor-pointer w-[20%]" data-sort="value" data-target="investment-rows">Value <i class="fas fa-sort ml-1 opacity-20"></i></th><th class="text-right w-[20%]">Cost Basis</th><th class="w-6"></th></tr>
                            </thead>
                            <tbody id="investment-rows" class="mono-numbers"></tbody>
                        </table>
                    </div>
                </div>

                <!-- Real Estate & HELOCs Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <div>
                        <div class="flex justify-between items-center mb-6 px-1">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-indigo-500/20 flex items-center justify-center text-indigo-400">
                                    <i class="fas fa-home text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white tracking-tight">Real Estate</h3>
                                    <p class="text-xs text-slate-500 font-medium mt-0.5">Primary home and properties</p>
                                </div>
                            </div>
                            <button data-add-row="real-estate-rows" data-row-type="realEstate" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div class="card-container overflow-hidden">
                            <table class="w-full text-xs">
                                <thead><tr><th class="text-left w-[40%]">Property</th><th class="text-right w-[22%]">Value</th><th class="text-right w-[18%]">Mortgage</th><th class="text-right w-[15%]">Principal</th><th class="w-6"></th></tr></thead>
                                <tbody id="real-estate-rows" class="mono-numbers"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-6 px-1">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center text-red-400">
                                    <i class="fas fa-university text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white tracking-tight">HELOCs</h3>
                                    <p class="text-xs text-slate-500 font-medium mt-0.5">Secured lines of credit</p>
                                </div>
                            </div>
                            <button data-add-row="heloc-rows" data-row-type="heloc" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div class="card-container overflow-hidden">
                            <table class="w-full text-xs">
                                <thead><tr><th class="text-left w-[40%]">Name</th><th class="text-right w-[20%]">Balance</th><th class="text-right w-[20%]">Limit</th><th class="text-center w-[12%]">Rate %</th><th class="w-6"></th></tr></thead>
                                <tbody id="heloc-rows" class="mono-numbers"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <!-- Other Assets & Debts Grid -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-12">
                    <div>
                        <div class="flex justify-between items-center mb-6 px-1">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-teal-500/20 flex items-center justify-center text-teal-400">
                                    <i class="fas fa-car text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white tracking-tight">Other Assets</h3>
                                    <p class="text-xs text-slate-500 font-medium mt-0.5">Vehicles and collectibles</p>
                                </div>
                            </div>
                            <button data-add-row="other-assets-rows" data-row-type="otherAsset" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div class="card-container overflow-hidden">
                            <table class="w-full text-xs">
                                <thead><tr><th class="text-left w-[45%]">Asset</th><th class="text-right w-[25%]">Value</th><th class="text-right w-[24%]">Loan</th><th class="w-6"></th></tr></thead>
                                <tbody id="other-assets-rows" class="mono-numbers"></tbody>
                            </table>
                        </div>
                    </div>
                    <div>
                        <div class="flex justify-between items-center mb-6 px-1">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-xl bg-red-500/20 flex items-center justify-center text-red-400">
                                    <i class="fas fa-credit-card text-sm"></i>
                                </div>
                                <div>
                                    <h3 class="text-lg font-bold text-white tracking-tight">Other Debt</h3>
                                    <p class="text-xs text-slate-500 font-medium mt-0.5">Unsecured loans and credit</p>
                                </div>
                            </div>
                            <button data-add-row="debt-rows" data-row-type="debt" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                        </div>
                        <div class="card-container overflow-hidden">
                            <table class="w-full text-xs">
                                <thead><tr><th class="text-left w-[45%]">Creditor</th><th class="text-right w-[25%]">Balance</th><th class="text-right w-[24%]">Payment</th><th class="w-6"></th></tr></thead>
                                <tbody id="debt-rows" class="mono-numbers"></tbody>
                            </table>
                        </div>
                    </div>
                </div>

                <div class="mb-12">
                    <div class="flex justify-between items-center mb-6 px-1">
                        <div class="flex items-center gap-4">
                            <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-400">
                                <i class="fas fa-briefcase text-sm"></i>
                            </div>
                            <div>
                                <h2 class="text-lg font-bold text-white tracking-tight">Private Equity</h2>
                                <p class="text-xs text-slate-500 font-medium mt-0.5">Stock options and grants</p>
                            </div>
                        </div>
                        <button data-add-row="stock-option-rows" data-row-type="stockOption" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <div class="card-container overflow-hidden">
                        <table class="w-full text-xs">
                            <thead>
                                <tr><th class="text-left w-[25%]">Name</th><th class="text-right w-[10%]">Shares</th><th class="text-right w-[12%]">Strike</th><th class="text-right w-[12%]">FMV</th><th class="text-center w-[8%]">APY %</th><th class="text-center w-[8%]">Tax</th><th class="text-right w-[19%]">Net Equity</th><th class="w-6"></th></tr>
                            </thead>
                            <tbody id="stock-option-rows" class="mono-numbers"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Income Tab -->
            <section id="tab-income" class="tab-content hidden max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p class="label-std mb-2 text-slate-500">2026 Gross Income</p>
                        <p id="sum-gross-income" class="text-4xl font-black text-teal-400 mono-numbers tracking-tight">$0</p>
                    </div>
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p class="label-std mb-2 text-slate-500">MAGI (Taxable Base)</p>
                        <p id="sum-income-adjusted" class="text-4xl font-black text-blue-400 mono-numbers tracking-tight">$0</p>
                    </div>
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p id="label-retirement-income-title" class="label-std mb-2 text-slate-500 text-center">Retirement Income</p>
                        <p id="sum-retirement-income-floor" class="text-4xl font-black text-teal-400 mono-numbers tracking-tight">$0</p>
                        <p id="sum-retirement-income-sub" class="text-[8px] font-bold text-slate-600 uppercase tracking-widest mt-1"></p>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-8 px-1">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-teal-500/20 flex items-center justify-center text-teal-400">
                            <i class="fas fa-money-bill-wave text-sm"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white tracking-tight">Income Streams</h2>
                            <p class="text-xs text-slate-500 font-medium mt-0.5">W2, 1099, and Passive Income</p>
                        </div>
                    </div>
                    <button data-add-row="income-cards" data-row-type="income" class="px-4 py-2 bg-blue-600 hover:bg-blue-500 text-white rounded-lg text-xs font-bold transition-all shadow-lg shadow-blue-900/20"><i class="fas fa-plus mr-2"></i>Add Income</button>
                </div>
                <div id="income-cards" class="grid grid-cols-1 md:grid-cols-2 xl:grid-cols-3 gap-6 items-start"></div>
            </section>

            <!-- Budget Tab -->
            <section id="tab-budget" class="tab-content hidden max-w-7xl mx-auto">
                 <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-12">
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p class="label-std mb-2 text-slate-500">Annual Savings</p>
                        <p id="sum-budget-savings" class="text-4xl font-black text-teal-400 mono-numbers tracking-tight">$0</p>
                    </div>
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p class="label-std mb-2 text-slate-500">Annual Spend</p>
                        <p id="sum-budget-annual" class="text-4xl font-black text-pink-500 mono-numbers tracking-tight">$0</p>
                    </div>
                    <div class="card-container p-6 flex flex-col items-center justify-center h-28">
                        <p id="label-retirement-budget-title" class="label-std mb-1 text-slate-500 text-center">Retirement Base Budget</p>
                        <p id="sum-budget-total" class="text-4xl font-black text-blue-400 mono-numbers tracking-tight">$0</p>
                        <p id="sum-retirement-budget-sub" class="text-[8px] font-bold text-slate-600 uppercase tracking-widest mt-1">2026 Purchasing Power</p>
                    </div>
                </div>

                <div class="mb-12">
                    <div class="flex items-center justify-between mb-6 px-1">
                        <div class="flex items-center gap-4">
                             <div class="w-10 h-10 rounded-xl bg-emerald-500/20 flex items-center justify-center text-emerald-400">
                                <i class="fas fa-piggy-bank text-sm"></i>
                             </div>
                             <div>
                                <h3 class="text-xl font-bold text-white tracking-tight">Annual Savings</h3>
                                <p class="text-xs text-slate-500 font-medium mt-0.5">Defined contributions and investments</p>
                             </div>
                        </div>
                        <button data-add-row="budget-savings-rows" data-row-type="budget-savings" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <div class="card-container overflow-hidden">
                        <table class="w-full text-xs">
                            <thead>
                                <tr><th class="w-10 pl-6"></th><th class="text-left">Asset Class</th><th class="text-center w-28">RETIREMENT?</th><th class="text-right w-48">Monthly</th><th class="text-right w-48">Annual</th><th class="w-16 pr-8"></th></tr>
                            </thead>
                            <tbody id="budget-savings-rows" class="mono-numbers"></tbody>
                        </table>
                    </div>
                </div>

                <div class="mb-12">
                    <div class="flex items-center justify-between mb-6 px-1">
                        <div class="flex items-center gap-4">
                             <div class="w-10 h-10 rounded-xl bg-pink-500/20 flex items-center justify-center text-pink-500">
                                <i class="fas fa-chart-pie text-sm"></i>
                             </div>
                             <div>
                                <h3 class="text-xl font-bold text-white tracking-tight">Living Expenses</h3>
                                <p class="text-xs text-slate-500 font-medium mt-0.5">Monthly breakdown of costs</p>
                             </div>
                        </div>
                        <button data-add-row="budget-expenses-rows" data-row-type="budget-expense" class="w-8 h-8 flex items-center justify-center bg-blue-600 hover:bg-blue-500 rounded-lg text-white transition-colors shadow-lg shadow-blue-900/20"><i class="fas fa-plus text-xs"></i></button>
                    </div>
                    <div class="card-container overflow-hidden">
                        <table class="w-full text-xs">
                            <thead class="text-slate-500 label-std border-b border-white/5">
                                <tr>
                                    <th class="w-10 pl-6"></th>
                                    <th class="text-left">Item Name</th>
                                    <th class="text-center w-36">RETIREMENT?</th>
                                    <th class="text-right w-48 group cursor-pointer" data-sort="monthly" data-target="budget-expenses-rows">Monthly <i class="fas fa-sort ml-1 opacity-20 group-hover:opacity-100 transition-opacity"></i></th>
                                    <th class="text-right w-48 group cursor-pointer" data-sort="annual" data-target="budget-expenses-rows">Annual <i class="fas fa-sort ml-1 opacity-20 group-hover:opacity-100 transition-opacity"></i></th>
                                    <th class="w-16 pr-8"></th>
                                </tr>
                            </thead>
                            <tbody id="budget-expenses-rows" class="mono-numbers"></tbody>
                        </table>
                    </div>
                </div>
            </section>

            <!-- Configuration Tab -->
            <section id="tab-assumptions" class="tab-content hidden max-w-7xl mx-auto">
                <div class="flex items-center gap-4 mb-8 px-1">
                    <div class="w-10 h-10 rounded-xl bg-teal-500/20 flex items-center justify-center text-teal-400">
                        <i class="fas fa-sliders-h text-sm"></i>
                    </div>
                    <h2 class="text-xl font-bold text-white tracking-tight">Configuration</h2>
                </div>
                <div id="assumptions-container" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 items-start"></div>
            </section>

            <!-- Benefits Tab -->
            <section id="tab-benefits" class="tab-content hidden max-w-7xl mx-auto">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-12">
                    <div id="benefit-summary-health" class="p-6 flex flex-col items-center justify-center h-28 border-l-4 border-emerald-500 transition-all rounded-2xl bg-slate-900/40 border border-white/5">
                        <p class="label-std mb-2 text-slate-500">Healthcare Plan</p>
                        <p id="sum-health-plan" class="text-2xl font-black text-white uppercase tracking-tight leading-none"></p>
                        <div class="flex gap-4 mt-2">
                             <div class="text-[9px] font-bold text-slate-500 uppercase"><span class="opacity-50">Prem:</span> <span id="sum-health-prem" class="text-white font-black">$0</span></div>
                             <div class="text-[9px] font-bold text-slate-500 uppercase"><span class="opacity-50">Ded:</span> <span id="sum-health-ded" class="text-white font-black">$0</span></div>
                        </div>
                    </div>
                    <div id="benefit-summary-snap" class="p-6 flex flex-col items-center justify-center h-28 border-l-4 border-teal-500 transition-all rounded-2xl bg-slate-900/40 border border-white/5">
                        <p class="label-std mb-2 text-slate-500">Est. SNAP (2026 Monthly)</p>
                        <p id="sum-snap-amt" class="text-4xl font-black text-teal-400 mono-numbers tracking-tight">$0</p>
                    </div>
                </div>
                
                <div class="flex items-center gap-4 mb-8 px-1">
                    <div class="w-10 h-10 rounded-xl bg-amber-500/20 flex items-center justify-center text-amber-400">
                        <i class="fas fa-hand-holding-heart text-sm"></i>
                    </div>
                    <h2 class="text-xl font-bold text-white tracking-tight">Benefit Optimization</h2>
                </div>

                <div id="benefits-module" class="space-y-8"></div>
            </section>

            <!-- Projection -->
            <section id="tab-projection" class="tab-content hidden max-w-7xl mx-auto">
                <!-- accumulation-only warning banner -->
                <div class="p-5 mb-8 bg-blue-500/10 border border-blue-500/20 rounded-2xl flex items-start gap-4">
                    <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-400 flex-shrink-0">
                        <i class="fas fa-info-circle"></i>
                    </div>
                    <div>
                        <h4 class="text-xs font-black text-white uppercase tracking-widest mb-1">Accumulation View (Gross Growth)</h4>
                        <p class="text-sm text-slate-400 leading-relaxed">
                            This is the typical "mountain chart" seen on financial calculators. <strong>It assumes you live off nothing!</strong> 
                            It only tracks compound growth and savings, without subtracting bills, taxes, or health costs. 
                            Switch to the <button onclick="document.querySelector('[data-tab=\'burndown\']').click()" class="text-blue-400 font-bold hover:underline">Burndown tab</button> for a realistic survival simulation.
                        </p>
                    </div>
                </div>

                <div class="flex justify-between items-center mb-8 px-1">
                    <div class="flex items-center gap-4">
                        <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center text-blue-400">
                            <i class="fas fa-chart-line text-sm"></i>
                        </div>
                        <div>
                            <h2 class="text-xl font-bold text-white tracking-tight">Asset Growth Projection</h2>
                            <p class="text-[10px] text-slate-500 font-bold uppercase tracking-wider mt-0.5">Compounding Power (Pre-Withdrawal)</p>
                        </div>
                    </div>
                    <div class="flex items-center gap-4">
                        <button id="toggle-projection-real" class="px-4 py-2 bg-white/5 hover:bg-white/10 border border-white/5 rounded-lg label-std text-slate-400 hover:text-white transition-all">
                            <i class="fas fa-sync mr-2"></i> Real Dollars
                        </button>
                        <div class="flex items-center gap-3 bg-white/5 px-4 py-2 rounded-lg border border-white/5">
                            <span class="label-std text-slate-500">CHART MAX: <span id="label-projection-end" class="text-blue-400 mono-numbers">72</span></span>
                            <input type="range" id="input-projection-end" min="70" max="100" value="72" class="w-24 h-1 bg-slate-700 rounded-full appearance-none cursor-pointer">
                        </div>
                    </div>
                </div>
                <div class="card-container p-6 mb-6 h-[500px] flex flex-col relative group">
                    <div class="flex-grow min-h-0">
                        <canvas id="projection-chart"></canvas>
                    </div>
                </div>
                <div id="projection-table-container" class="card-container overflow-hidden mb-12"></div>
            </section>

            <!-- Burndown -->
            <section id="tab-burndown" class="tab-content hidden max-w-7xl mx-auto">
                <!-- Dashboard (Preservation Age, etc.) injected here -->
                <div id="burndown-view-container" class="mb-12"></div>
                
                <div id="burndown-debug-container" class="p-8 bg-black/20 border border-white/5 rounded-[24px] shadow-inner mb-6">
                    <div class="flex items-center justify-between mb-4">
                         <div class="flex items-center gap-3">
                            <i class="fas fa-terminal text-blue-400"></i>
                            <h3 class="text-xs font-black text-white uppercase tracking-widest">Advanced Logic Trace</h3>
                         </div>
                         <div class="flex items-center gap-3">
                            <label class="text-[10px] font-bold text-slate-500 uppercase tracking-widest">Age:</label>
                            <div class="bg-black/40 rounded-lg p-1 flex items-center gap-1">
                                <button id="btn-debug-minus" class="w-6 h-6 flex items-center justify-center hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors"><i class="fas fa-minus text-[10px]"></i></button>
                                <input type="number" id="input-debug-age" min="30" max="100" placeholder="Age" class="bg-transparent border-none text-xs text-blue-400 font-bold outline-none w-10 text-center mono-numbers">
                                <button id="btn-debug-plus" class="w-6 h-6 flex items-center justify-center hover:bg-slate-700 rounded text-slate-400 hover:text-white transition-colors"><i class="fas fa-plus text-[10px]"></i></button>
                            </div>
                         </div>
                    </div>
                    <div id="burndown-trace-log" class="text-[11px] font-mono leading-relaxed text-slate-400 bg-black/40 p-6 rounded-xl border border-white/5 max-h-[400px] overflow-y-auto whitespace-pre-wrap">
                        Select an age or run simulation to see logic trace...
                    </div>
                </div>

                <!-- Engine Documentation -->
                <div class="flex flex-col items-center">
                    <button id="btn-toggle-engine-doc" class="px-6 py-3 bg-slate-800 border border-slate-700 hover:bg-slate-700 text-slate-400 hover:text-white rounded-xl text-[10px] font-black uppercase tracking-widest transition-all mb-4">
                        <i class="fas fa-question-circle mr-2"></i> HOW IT WORKS
                    </button>
                    
                    <div id="engine-logic-doc" class="hidden w-full max-w-4xl bg-slate-900/40 border border-white/5 rounded-[32px] p-8 md:p-12 space-y-12">
                        <!-- Stage 1 -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-emerald-500/20 flex items-center justify-center text-emerald-400 font-black text-sm">1</div>
                                <h4 class="text-xl font-black text-white tracking-tight uppercase">Stage 1: Accumulation Phase (The Build)</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pl-14">
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">A: Gross Inflow</p>
                                        <p class="text-sm text-slate-300">Sum of all W2/1099 streams based on current age and projected growth. Pre-tax contributions are subtracted to find the <strong>MAGI Base</strong>.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">B: Tax Siphoning</p>
                                        <p class="text-sm text-slate-300">Federal, State, and FICA taxes are calculated. Note: FICA is applied only to W2 gross portions.</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">C: Defined Savings Only</p>
                                        <p class="text-sm text-slate-300">Only funds explicitly saved in the Savings table are added to accounts. Excess take-home pay is treated as "spent" to ensure conservative planning.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">D: Compounding Loop</p>
                                        <p class="text-sm text-slate-300">Each year applies your specific APY settings (Stock, Crypto, RE) to existing balances <em>before</em> adding the current year's contributions.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stage 2 -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-blue-500/20 flex items-center justify-center text-blue-400 font-black text-sm">2</div>
                                <h4 class="text-xl font-black text-white tracking-tight uppercase">Stage 2: The Decumulation Bridge</h4>
                            </div>
                            <div class="pl-14 space-y-6">
                                <p class="text-sm text-blue-300 font-bold italic leading-relaxed">This is the engine's core. It must solve for the annual budget while optimizing for tax brackets and healthcare subsidies.</p>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-8">
                                    <div class="space-y-4">
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">A: Required Outflow</p>
                                            <p class="text-sm text-slate-300">Calculates <strong>Budget + Taxes + HELOC Interest</strong>. The engine services debt interest as a priority expense to prevent balance spiraling.</p>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">B: MAGI Strategy Spiral</p>
                                            <p class="text-sm text-slate-300">The engine performs a 3-pass calculation. Withdrawals create taxes, which create more shortfall. It iterates until the "Net Check" satisfies your bills.</p>
                                        </div>
                                    </div>
                                    <div class="space-y-4">
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">C: 72(t) / SEPP Logic</p>
                                            <p class="text-sm text-slate-300">If you retire under 59.5, the engine calculates the maximum IRS-allowed Systematic Withdrawal (SEPP) to bridge the gap without penalties.</p>
                                        </div>
                                        <div class="space-y-1">
                                            <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">D: Smart Fill Waterfall</p>
                                            <p class="text-sm text-slate-300">Assets are drained in your custom drag-and-drop order. It prioritizes survival (meeting budget) over strategy (hitting tax targets).</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stage 3 -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-amber-500/20 flex items-center justify-center text-amber-400 font-black text-sm">3</div>
                                <h4 class="text-xl font-black text-white tracking-tight uppercase">Stage 3: Benefit Recalculation Engine</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pl-14">
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">A: Dynamic Dependent Recalculation</p>
                                        <p class="text-sm text-slate-300">The simulator checks your <strong>Dependent Independence Dates</strong> for every year. When a child ages out, the household size (hhSize) decreases immediately.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">B: FPL Ratio Shift</p>
                                        <p class="text-sm text-slate-300">A lower hhSize lowers your FPL threshold. An income that was 138% FPL (Platinum) for a family of 4 might become 220% FPL (Silver) for a family of 2.</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">C: Automated Strategy Pivots</p>
                                        <p class="text-sm text-slate-300">As thresholds shift, the engine automatically adjusts its withdrawal targets to stay within your selected Persona limits (Platinum/Silver), even as the rules change mid-retirement.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">D: Benefit Cliff Visualization</p>
                                        <p class="text-sm text-slate-300">The Burndown table's <strong>"Health Status"</strong> column will visually shift colors in the exact year your household composition changes, highlighting potential cost spikes.</p>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Stage 4 -->
                        <div class="space-y-6">
                            <div class="flex items-center gap-4">
                                <div class="w-10 h-10 rounded-full bg-purple-500/20 flex items-center justify-center text-purple-400 font-black text-sm">4</div>
                                <h4 class="text-xl font-black text-white tracking-tight uppercase">Stage 4: Legacy & Reinvestment</h4>
                            </div>
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 pl-14">
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">A: Cash Surplus Recycling</p>
                                        <p class="text-sm text-slate-300">In strategy years (like harvesting for "Platinum Max"), any leftover cash from mandatory RMDs or harvesting is <strong>recycled</strong> back into your Cash bucket.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">B: Dynamic Debt Paydown</p>
                                        <p class="text-sm text-slate-300">If year-end income exceeds your budget, the engine applies the surplus to <strong>HELOC Principal</strong> before adding to savings.</p>
                                    </div>
                                </div>
                                <div class="space-y-4">
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">C: Social Security Layering</p>
                                        <p class="text-sm text-slate-300">The engine automatically calculates the taxable portion of SS based on provisional income rules, layering it over your strategy draws.</p>
                                    </div>
                                    <div class="space-y-1">
                                        <p class="text-[10px] font-black text-slate-500 uppercase tracking-widest">D: RMD Logic</p>
                                        <p class="text-sm text-slate-300">At age 75, Required Minimum Distributions are forced, potentially overriding your strategy targets to satisfy IRS compliance.</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Dynamic import -->
    <script type="module">
        import "./main.js"; 
    </script>
</body>
</html>